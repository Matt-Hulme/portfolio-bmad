#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Detect if frontend or backend files changed
FRONTEND_CHANGED=$(echo "$STAGED_FILES" | grep -q "^frontend/" && echo "true" || echo "false")
BACKEND_CHANGED=$(echo "$STAGED_FILES" | grep -q "^backend/" && echo "true" || echo "false")

# Track if any checks fail
CHECKS_FAILED=0

# Frontend checks
if [ "$FRONTEND_CHANGED" = "true" ]; then
  echo "üì¶ Frontend files changed, running frontend checks..."

  cd frontend || exit 1

  echo "  ‚úì Running ESLint..."
  npm run lint || CHECKS_FAILED=1

  echo "  ‚úì Running Prettier..."
  npm run format:check || CHECKS_FAILED=1

  echo "  ‚úì Running TypeScript check..."
  npx tsc --noEmit || CHECKS_FAILED=1

  echo "  ‚úì Running tests..."
  npm test -- --run || CHECKS_FAILED=1

  cd ..
fi

# Backend checks
if [ "$BACKEND_CHANGED" = "true" ]; then
  echo "üêç Backend files changed, running backend checks..."

  cd backend || exit 1

  echo "  ‚úì Running Ruff..."
  ruff check . || CHECKS_FAILED=1

  echo "  ‚úì Running Black..."
  black --check . || CHECKS_FAILED=1

  echo "  ‚úì Running MyPy..."
  mypy . || CHECKS_FAILED=1

  echo "  ‚úì Running pytest..."
  pytest -v || CHECKS_FAILED=1

  cd ..
fi

# Exit with failure if any checks failed
if [ $CHECKS_FAILED -eq 1 ]; then
  echo "‚ùå Pre-commit checks failed! Fix the issues above before committing."
  exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
exit 0
